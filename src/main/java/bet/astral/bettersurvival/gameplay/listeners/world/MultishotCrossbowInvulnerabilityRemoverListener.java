package bet.astral.bettersurvival.gameplay.listeners.world;

import bet.astral.bettersurvival.BetterSurvival;
import org.bukkit.NamespacedKey;
import org.bukkit.enchantments.Enchantment;
import org.bukkit.entity.LivingEntity;
import org.bukkit.entity.Projectile;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.event.entity.EntityShootBowEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.persistence.PersistentDataType;
import org.jetbrains.annotations.NotNull;

public class MultishotCrossbowInvulnerabilityRemoverListener implements Listener {
	private final BetterSurvival survival;
	private final NamespacedKey key;

	public MultishotCrossbowInvulnerabilityRemoverListener(BetterSurvival survival) {
		this.survival = survival;
		key = survival.key("multishot_hit");
	}

	@EventHandler
	private void onShoot(EntityShootBowEvent event){
		ItemStack itemStack = event.getBow();
		if (itemStack == null){
			return;
		}
		if (itemStack.getType().isEmpty()){
			return;
		}
		if (itemStack.containsEnchantment(Enchantment.MULTISHOT)){
			event.getEntity().getPersistentDataContainer().set(key, PersistentDataType.BOOLEAN, true);
		}
	}

	@EventHandler
	private void onDamage(@NotNull EntityDamageByEntityEvent event){
		if (event.getEntity() instanceof LivingEntity entity){
			if (event.getDamager() instanceof Projectile projectile){
				if (projectile.getPersistentDataContainer().getOrDefault(key, PersistentDataType.BOOLEAN, false)){
					entity.setNoDamageTicks(0);
				}
			}
		}
	}
}
